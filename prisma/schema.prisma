// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USUARIOS Y AUTENTICACIÓN
// ============================================

// Usuarios del sistema
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String    // hashed password
  name         String
  role         String    @default("tenant") // admin, tenant
  tenantId     String?   @unique // si es tenant, vinculado al inquilino
  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email])
  @@index([role])
}

// ============================================
// PROPIEDADES Y HABITACIONES
// ============================================

// Propiedades/Viviendas
model Property {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  postalCode  String
  description String?
  image       String?
  rooms       Room[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Habitaciones
model Room {
  id         String     @id @default(cuid())
  number     String
  name       String?
  floor      Int        @default(1)
  price      Float
  size       Float?     // en metros cuadrados
  amenities  String?    // JSON string con amenities
  status     String     @default("available") // available, occupied, maintenance
  image      String?
  propertyId String
  property   Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenants    Tenant[]
  incidents  Incident[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([propertyId, number])
}

// ============================================
// INQUILINOS
// ============================================

// Inquilinos
model Tenant {
  id        String     @id @default(cuid())
  name      String
  email     String
  phone     String?
  dni       String?
  photo     String?
  moveIn    DateTime
  moveOut   DateTime?
  status    String     @default("active") // active, inactive
  roomId    String
  room      Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User?
  incidents Incident[]
  payments  Payment[]
  contracts Contract[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// ============================================
// INCIDENCIAS
// ============================================

// Incidencias
model Incident {
  id          String          @id @default(cuid())
  title       String
  description String
  category    String          // plumbing, electrical, furniture, cleaning, other
  priority    String          @default("medium") // low, medium, high, urgent
  status      String          @default("open") // open, in_progress, resolved, closed
  image       String?
  roomId      String
  room        Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenantId    String?
  tenant      Tenant?         @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  updates     IncidentUpdate[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Actualizaciones de incidencias
model IncidentUpdate {
  id         String   @id @default(cuid())
  message    String
  status     String?  // cambio de estado si aplica
  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
}

// ============================================
// CONTROL DE PAGOS
// ============================================

// Pagos
model Payment {
  id            String    @id @default(cuid())
  amount        Float     // cantidad
  concept       String    // alquiler, fianza, luz, agua, gas, otros
  status        String    @default("pending") // pending, paid, overdue, cancelled
  dueDate       DateTime  // fecha de vencimiento
  paidDate      DateTime? // fecha en que se pagó
  paymentMethod String?   // cash, transfer, card
  reference     String?   // número de referencia/recibo
  notes         String?   // notas adicionales
  receiptUrl    String?   // URL del recibo generado
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([dueDate])
  @@index([tenantId])
}

// ============================================
// GESTIÓN DE CONTRATOS
// ============================================

// Contratos
model Contract {
  id              String    @id @default(cuid())
  contractNumber  String    @unique // número de contrato único
  startDate       DateTime  // fecha de inicio
  endDate         DateTime  // fecha de fin
  monthlyRent     Float     // alquiler mensual
  deposit         Float     // fianza
  depositPaid     Boolean   @default(false) // si se ha pagado la fianza
  depositReturned Boolean   @default(false) // si se ha devuelto la fianza
  status          String    @default("active") // active, expired, terminated, cancelled
  terms           String?   // términos y condiciones (texto largo)
  documentUrl     String?   // URL del documento PDF firmado
  notes           String?   // notas adicionales
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([endDate])
  @@index([tenantId])
}

// Forzando actualizacion a Postgres
